name: –ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞ Music M (Unpacked - –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)

on:
  workflow_dispatch:
    inputs:
      namevers:
        description: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞"
        required: true
        default: "ü§ñ –ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞"
      descr:
        description: "–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞"
        required: true
        default: "‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
      release:
        description: "–í—ã–∫–∏–Ω—É—Ç—å –≤ —Ä–µ–ª–∏–∑?"
        required: true
        default: false
        type: boolean
      prerelease:
        description: "–ü—Ä–µ—Ä–µ–ª–∏–∑?"
        required: true
        default: true
        type: boolean

  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-unpacked-all:
    runs-on: windows-latest
    env:
      Solution_Name: "VK UI3"
      Configuration: Unpacked

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –§–∏–∫—Å–∏—Ä—É–µ–º SDK 8.0
      - name: Pin .NET SDK 8 via global.json
        run: |
          Set-Content -Path global.json -Value '{ "sdk": { "version": "8.0.100", "rollForward": "feature" } }'

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # PFX
      - name: Decode PFX
        run: |
          $bytes = [Convert]::FromBase64String("${{ secrets.BASE64_ENCODED_PFX }}")
          $certPath = "${{ github.workspace }}\signcert.pfx"
          [IO.File]::WriteAllBytes($certPath, $bytes)

# –°–±–æ—Ä–∫–∞, –ø–æ–¥–ø–∏—Å—å, —É–ø–∞–∫–æ–≤–∫–∞
- name: Build, sign, zip all
  shell: pwsh
  run: |
    $certPath = "${{ github.workspace }}\signcert.pfx"
    $password = "${{ secrets.PFX_PASSWORD }}"

    # –ò—â–µ–º signtool.exe –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ (x64)
    $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe |
                Where-Object { $_.FullName -match 'x64' } |
                Select-Object -First 1 -ExpandProperty FullName
    if (-not $signtool) { throw "signtool.exe –Ω–µ –Ω–∞–π–¥–µ–Ω" }

    $arches = @(
      @{ Platform = "x64";   RID = "win-x64"   },
      @{ Platform = "x86";   RID = "win-x86"   },
      @{ Platform = "ARM64"; RID = "win-arm64" }
    )

    foreach ($a in $arches) {
      Write-Host "=== Build $($a.Platform) (RID=$($a.RID)) ==="

      msbuild "$env:Solution_Name\$env:Solution_Name.csproj" `
        /restore `                                # –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π restore –¥–ª—è –Ω—É–∂–Ω–æ–≥–æ RID
        /p:Configuration=$env:Configuration `
        /p:Platform=$($a.Platform) `
        /p:RuntimeIdentifier=$($a.RID) `
        /p:DisableRuntimeIdentifierInference=true `
        /p:EnableNETAnalyzers=false `             # –≤—ã—Ä—É–±–∞–µ—Ç .NET –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã (–∏—Ö –≤–∞—Ä–Ω–∏–Ω–≥–∏)
        /p:WarningLevel=0 `                       # —Å–∫—Ä—ã–≤–∞–µ—Ç C# –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (csc)
        /p:TreatWarningsAsErrors=false `          # –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —á—Ç–æ–±—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –Ω–µ –≤–∞–ª–∏–ª–∏ –±–∏–ª–¥
        /clp:ErrorsOnly                           # –≤—ã–≤–æ–¥–∏—Ç –≤ –∫–æ–Ω—Å–æ–ª—å —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏

      $exe = Get-ChildItem "$env:Solution_Name\bin\$($a.Platform)\$env:Configuration" -Recurse -Include *.exe | Select-Object -First 1
      if (-not $exe) { throw "–ù–µ –Ω–∞–π–¥–µ–Ω exe –¥–ª—è $($a.Platform)" }

      & $signtool sign /f $certPath /p $password /tr http://timestamp.digicert.com /td sha256 /fd sha256 $exe.FullName

      $zipName = "VK_UI3_$($a.Platform).zip"
      if (Test-Path $zipName) { Remove-Item $zipName -Force }
      Compress-Archive -Path $exe.FullName -DestinationPath $zipName -Force
    }


      # –ó–∞–≥—Ä—É–∑–∫–∞ –≤ —Ä–µ–ª–∏–∑
      - name: Upload zips to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.TOKEN }}
          file: VK_UI3_*.zip
          tag: ${{ github.ref_name }}
          overwrite: true
          file_glob: true

