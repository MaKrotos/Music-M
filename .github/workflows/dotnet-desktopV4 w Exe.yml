name: –ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞ Music M (Unpacked - –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)

on:
  workflow_dispatch:
    inputs:
      namevers:
        description: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞"
        required: true
        default: "ü§ñ –ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞"
      descr:
        description: "–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞"
        required: true
        default: "‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
      release:
        description: "–í—ã–∫–∏–Ω—É—Ç—å –≤ —Ä–µ–ª–∏–∑?"
        required: true
        default: false
        type: boolean
      prerelease:
        description: "–ü—Ä–µ—Ä–µ–ª–∏–∑?"
        required: true
        default: true
        type: boolean

  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-unpacked:
    strategy:
      matrix:
        arch: [x64, x86, ARM64]
    runs-on: windows-latest

    env:
      Solution_Name: "VK UI3"
      Configuration: Unpacked

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –î–µ–∫–æ–¥–∏—Ä—É–µ–º pfx
      - name: Decode the pfx
        run: |
          $pfxBytes = [Convert]::FromBase64String("${{ secrets.BASE64_ENCODED_PFX }}")
          $certPath = "${{ github.workspace }}\signcert.pfx"
          [IO.File]::WriteAllBytes($certPath, $pfxBytes)

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore
        run: msbuild $env:Solution_Name\$env:Solution_Name.csproj /t:Restore /p:Configuration=$env:Configuration

      - name: Build ${{ matrix.arch }}
        run: |
          msbuild $env:Solution_Name\$env:Solution_Name.csproj `
            /p:Configuration=$env:Configuration `
            /p:Platform=${{ matrix.arch }}

      # –ü–æ–¥–ø–∏—Å—å exe
      - name: Sign exe
        run: |
          $certPath = "${{ github.workspace }}\signcert.pfx"
          $password = "${{ secrets.PFX_PASSWORD }}"
          $exePath = Get-ChildItem "VK UI3\bin\${{ matrix.arch }}\Unpacked\*.exe" | Select-Object -First 1
          & "C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe" sign `
            /f $certPath /p $password /tr http://timestamp.digicert.com /td sha256 /fd sha256 $exePath.FullName

      # –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
      - name: Create zip
        run: |
          $exePath = Get-ChildItem "VK UI3\bin\${{ matrix.arch }}\Unpacked\*.exe" | Select-Object -First 1
          $zipName = "VK_UI3_${{ matrix.arch }}.zip"
          Compress-Archive -Path $exePath.FullName -DestinationPath $zipName
        shell: pwsh

      # –ó–∞–≥—Ä—É–∑–∫–∞ –≤ —Ä–µ–ª–∏–∑
      - name: Upload to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.TOKEN }}
          file: VK_UI3_${{ matrix.arch }}.zip
          asset_name: VK_UI3_${{ matrix.arch }}.zip
          tag: ${{ github.ref_name }}
          overwrite: true
