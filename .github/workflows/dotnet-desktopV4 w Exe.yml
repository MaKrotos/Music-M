name: –ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞ Music M (Unpacked - –≤—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)

on:
  workflow_dispatch:
    inputs:
      namevers:
        description: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞"
        required: true
        default: "ü§ñ –ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞"
      descr:
        description: "–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞"
        required: true
        default: "‚ùå –û–ø–∏—Å–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
      release:
        description: "–í—ã–∫–∏–Ω—É—Ç—å –≤ —Ä–µ–ª–∏–∑?"
        required: true
        default: false
        type: boolean
      prerelease:
        description: "–ü—Ä–µ—Ä–µ–ª–∏–∑?"
        required: true
        default: true
        type: boolean

  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-unpacked-all:
    runs-on: windows-latest
    env:
      Solution_Name: "VK UI3"
      Configuration: Unpacked

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å .NET SDK 8.x (msbuild –±—É–¥–µ—Ç —Ä–µ–∑–æ–ª–≤–∏—Ç—å –∏–º–µ–Ω–Ω–æ –µ–≥–æ)
      - name: Pin .NET SDK 8 via global.json
        run: |
          Set-Content -Path global.json -Value '{ "sdk": { "version": "8.0.100", "rollForward": "feature" } }'

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # PFX
      - name: Decode PFX
        run: |
          $bytes = [Convert]::FromBase64String("${{ secrets.BASE64_ENCODED_PFX }}")
          $certPath = "${{ github.workspace }}\signcert.pfx"
          [IO.File]::WriteAllBytes($certPath, $bytes)

      # Restore
      - name: Restore
        run: msbuild "$env:Solution_Name\$env:Solution_Name.csproj" /t:Restore /p:Configuration=$env:Configuration

      # –°–±–æ—Ä–∫–∞, –ø–æ–¥–ø–∏—Å—å –∏ —É–ø–∞–∫–æ–≤–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä
      - name: Build, sign, zip (x64, x86, ARM64)
        shell: pwsh
        run: |
          $certPath = "${{ github.workspace }}\signcert.pfx"
          $password = "${{ secrets.PFX_PASSWORD }}"
          $arches = @(
            @{ Platform = "x64";   RID = "win-x64"   },
            @{ Platform = "x86";   RID = "win-x86"   },
            @{ Platform = "ARM64"; RID = "win-arm64" }
          )

          foreach ($a in $arches) {
            Write-Host "=== Build $($a.Platform) (RID=$($a.RID)) ==="

            msbuild "$env:Solution_Name\$env:Solution_Name.csproj" `
              /p:Configuration=$env:Configuration `
              /p:Platform=$($a.Platform) `
              /p:RuntimeIdentifier=$($a.RID) `
              /p:DisableRuntimeIdentifierInference=true

            # EXE –º–æ–∂–µ—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è –≥–ª—É–±–∂–µ (–ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ RID —É SDK –ø–æ—è–≤–ª—è—é—Ç—Å—è –¥–æ–ø. –ø–æ–¥–ø–∞–ø–∫–∏)
            $exe = Get-ChildItem "$env:Solution_Name\bin\$($a.Platform)\$env:Configuration" -Recurse -Include *.exe | Select-Object -First 1
            if (-not $exe) { throw "–ù–µ –Ω–∞–π–¥–µ–Ω exe –¥–ª—è $($a.Platform)" }

            & "C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe" sign `
              /f $certPath /p $password /tr http://timestamp.digicert.com /td sha256 /fd sha256 $exe.FullName

            $zipName = "VK_UI3_$($a.Platform).zip"
            if (Test-Path $zipName) { Remove-Item $zipName -Force }
            Compress-Archive -Path $exe.FullName -DestinationPath $zipName -Force
          }

      # –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö zip –≤ —Ä–µ–ª–∏–∑ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ç–µ–≥ —Ä–µ–ª–∏–∑–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
      - name: Upload all zips to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.TOKEN }}
          file: VK_UI3_*.zip
          tag: ${{ github.ref_name }}
          overwrite: true
          file_glob: true
